<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Traffic by Country â€” Finviz-style Treemap</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
    :root{
      --bg:#262931; --panel:#161b22; --muted:#8b949e; --border:#30363d; --tile-gap:#262931; /* ë°°ê²½ ìƒ‰ìƒ */
      --green-weak:#39D353; --green-mid:#00C853; --green-strong:#00E676; --green-max:#00FF00;
      --red-weak:#FF6E6E; --red-mid:#FF3B3B; --red-strong:#FF1A1A; --red-max:#FF0000;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,var(--bg),#161b22);color:#fff;min-height:100vh}
    .container{max-width:1920px;margin:0 auto;background:var(--bg)}
    .header{background:linear-gradient(135deg,#161b22,#1c2128);border-bottom:1px solid var(--border);padding:18px 22px}
    .header h1{font-size:20px;font-weight:700;letter-spacing:-.2px}
    .header p{font-size:12px;color:var(--muted);margin-top:4px;display:flex;align-items:center;gap:8px}
    .toolbar,.filter-controls{padding:14px 22px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .toolbar input[type="file"], .filter-controls input[type="number"], .filter-controls select{padding:8px 12px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px}
    .toolbar button{padding:8px 14px;background:linear-gradient(135deg,#238636,#2ea043);border:none;border-radius:6px;color:#fff;font-weight:600;cursor:pointer}
    .status-badge{background:linear-gradient(135deg,#238636,#2ea043);padding:6px 10px;border-radius:6px;font-size:12px}
    .content{padding:18px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px}
    .stat-item{background:linear-gradient(135deg,#161b22,#1c2128);border:1px solid var(--border);border-radius:8px;padding:14px}
    .stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px}
    .stat-value{font-size:22px;font-weight:700}
    .stat-value.positive{color:#00ff00}
    .stat-value.negative{color:#ff4d4d}
    #treemap{width:100%;min-height:900px;background:var(--tile-gap);border:1px solid var(--border);border-radius:8px;position:relative;overflow:hidden}
    .loading-overlay{position:absolute;inset:0;background:rgba(13,17,23,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000}
    .loading-spinner{border:4px solid var(--border);border-top:4px solid #238636;border-radius:50%;width:46px;height:46px;animation:spin 1s linear infinite;margin-bottom:12px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .badge{display:inline-flex;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(135deg,#161b22,#1c2128);font-size:12px}
    .badge[data-tip]{position:relative}
    .badge[data-tip]:hover::after{content:attr(data-tip);position:absolute;left:50%;transform:translateX(-50%);bottom:calc(100% + 10px);white-space:nowrap;background:#161b22;color:#fff;padding:8px 10px;border-radius:8px;border:1px solid var(--border)}
    @media (max-width:768px){.header{padding:14px}.content{padding:12px}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
      <h1>ğŸŒ Traffic by Country</h1>
        </div>
        
        <div class="toolbar">
      <input type="file" id="csvFile" accept=".csv"/>
      <button id="btnLoad">ğŸ“ Load CSV</button>
      <div class="status-badge" id="status">Sample Data (250 Countries)</div>
    </div>

    <div class="filter-controls">
      <label><strong>Show Top:</strong> <input type="number" id="topCount" value="180" min="10" max="250"/></label>
      <label><strong>Sort By:</strong>
        <select id="sortBy">
          <option value="revenue" selected>A.DAU (í‰ê·  DAU)</option>
          <option value="change_desc">+ ë³€í™”ëŸ‰ í° ìˆœ</option>
          <option value="change_asc">- ë³€í™”ëŸ‰ í° ìˆœ</option>
        </select>
      </label>
      <label><input type="checkbox" id="groupByContinent" checked/> <strong>Group by Sector (Continent)</strong></label>
          <label style="margin-top:8px"><strong>Comparison:</strong>
        <select id="comparisonType" style="padding:6px 10px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px;margin-left:8px;font-size:13px">
          <option value="DoD">DoD (ì „ì¼ ëŒ€ë¹„: ë§ˆì§€ë§‰ ë‚  vs ë§ˆì§€ë§‰-1ì¼)</option>
          <option value="WoW" selected>WoW (ì£¼ê°„ ëŒ€ë¹„: ì›”~í†  ê¸°ì¤€ ì§ì „ì£¼)</option>
          <option value="MoM">MoM (ì›”ê°„ ëŒ€ë¹„: 1ê°œì›” ì „)</option>
          <option value="YoY">YoY (ì—°ê°„ ëŒ€ë¹„: 1ë…„ ì „)</option>
        </select>
      </label>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px;padding-top:12px;border-top:1px solid var(--border)">
        <label><strong>Date Range:</strong> 
          <input type="date" id="startDate" style="padding:6px 10px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px;margin-left:8px"/>
        </label>
        <label><strong>~</strong> 
          <input type="date" id="endDate" style="padding:6px 10px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px;margin-left:8px"/>
        </label>
        <button id="btnApplyDateRange" style="padding:6px 12px;background:linear-gradient(135deg,#238636,#2ea043);border:none;border-radius:6px;color:#fff;font-weight:600;cursor:pointer;font-size:12px">Apply</button>
        <button id="btnClearDateRange" style="padding:6px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:#fff;font-weight:600;cursor:pointer;font-size:12px">Clear</button>
      </div>
        </div>
        
        <div class="content">
            <div class="stats-grid" id="stats"></div>
      <div id="comparisonRange" style="font-size:16px;color:#fff;margin-bottom:16px;padding:14px;background:var(--panel);border-radius:8px;border:1px solid var(--border);text-align:center;font-weight:700;letter-spacing:0.5px"></div>
      <div id="treemap">
        <div class="loading-overlay" id="loadingOverlay">
          <div class="loading-spinner"></div>
          <div class="loading-text" style="color:var(--muted)">ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
        </div>
      </div>
      <div class="color-palette" style="margin-top:20px;padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:8px">
        <div style="font-size:12px;color:var(--muted);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600">Color Palette</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="width:24px;height:24px;background:#f63538;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
            <span style="color:#fff;font-size:13px;font-weight:600">-3%</span>
          </div>
          <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="width:24px;height:24px;background:#bf4045;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
            <span style="color:#fff;font-size:13px;font-weight:600">-2%</span>
          </div>
          <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="width:24px;height:24px;background:#8b444e;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
            <span style="color:#fff;font-size:13px;font-weight:600">-1%</span>
          </div>
          <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="width:24px;height:24px;background:#414554;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
            <span style="color:#fff;font-size:13px;font-weight:600">0%</span>
          </div>
          <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="width:24px;height:24px;background:#3e7c55;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
            <span style="color:#fff;font-size:13px;font-weight:600">+1%</span>
          </div>
          <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="width:24px;height:24px;background:#2f9e4f;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
            <span style="color:#fff;font-size:13px;font-weight:600">+2%</span>
          </div>
          <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="width:24px;height:24px;background:#30cc5a;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
            <span style="color:#fff;font-size:13px;font-weight:600">+3%</span>
          </div>
        </div>
      </div>
      <div id="regionTraffic" style="margin-top:20px;padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:8px">
        <div id="regionTrafficTitle" style="font-size:16px;color:var(--muted);margin-bottom:16px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600">ê¶Œì—­ë³„ íŠ¸ë˜í”½ ë¹„ì¤‘</div>
        <div style="overflow-x:auto">
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="border-bottom:1px solid var(--border)">
                <th style="padding:12px;text-align:left;font-size:14px;color:var(--muted);font-weight:600">ê¶Œì—­</th>
                <th style="padding:12px;text-align:right;font-size:14px;color:var(--muted);font-weight:600">Traffic</th>
                <th style="padding:12px;text-align:right;font-size:14px;color:var(--muted);font-weight:600">ë¹„ì¤‘</th>
                <th style="padding:12px;text-align:right;font-size:14px;color:var(--muted);font-weight:600">Avg Change</th>
              </tr>
            </thead>
            <tbody id="regionTrafficBody">
              <tr><td colspan="4" style="padding:16px;text-align:center;color:var(--muted);font-size:14px">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div id="trafficTop10" style="margin-top:20px;padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:8px">
        <div id="trafficTop10Title" style="font-size:16px;color:var(--muted);margin-bottom:16px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600">Traffic Top 10 (DoD ê¸°ì¤€)</div>
        <div style="overflow-x:auto">
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="border-bottom:1px solid var(--border)">
                <th style="padding:12px;text-align:left;font-size:14px;color:var(--muted);font-weight:600">Rank</th>
                <th style="padding:12px;text-align:left;font-size:14px;color:var(--muted);font-weight:600">Country</th>
                <th style="padding:12px;text-align:right;font-size:14px;color:var(--muted);font-weight:600">Traffic</th>
                <th style="padding:12px;text-align:right;font-size:14px;color:var(--muted);font-weight:600">Change</th>
              </tr>
            </thead>
            <tbody id="trafficTop10Body">
              <tr><td colspan="4" style="padding:16px;text-align:center;color:var(--muted);font-size:14px">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
        </div>
        
    <div class="footer" style="padding:14px;background:var(--panel);border-top:1px solid var(--border);color:var(--muted);text-align:center;font-size:12px">
      ğŸ“Š CSV Format: Date,Country,Traffic (ë‚ ì§œëŠ” ì¤‘êµ¬ë‚œë°© ê°€ëŠ¥, ë‚˜ë¼ë³„ ìë™ í”¼ë²—) Â· Hover tiles for details
        </div>
    </div>

    <script>
    // ---------- Mapping: Country â†’ Region (ê²Œì„ ì—…ê³„ í‘œì¤€ ê¶Œì—­) ----------
    const countryToContinent = {
      // NA (North America)
      'USA':'NA','United States':'NA','Canada':'NA',
      // LATAM (Latin America)
      'Mexico':'LATAM','Brazil':'LATAM','Argentina':'LATAM','Chile':'LATAM','Colombia':'LATAM','Peru':'LATAM','Ecuador':'LATAM','Venezuela':'LATAM','Uruguay':'LATAM','Paraguay':'LATAM','Bolivia':'LATAM','Suriname':'LATAM','Guyana':'LATAM','French Guiana':'LATAM','Falkland Islands':'LATAM','Aruba':'LATAM','Guatemala':'LATAM','Honduras':'LATAM','El Salvador':'LATAM','Nicaragua':'LATAM','Costa Rica':'LATAM','Panama':'LATAM','Cuba':'LATAM','Jamaica':'LATAM','Haiti':'LATAM','Dominican Republic':'LATAM','Trinidad':'LATAM','Trinidad and Tobago':'LATAM','Barbados':'LATAM','Bahamas':'LATAM','Belize':'LATAM','Puerto Rico':'LATAM','Curacao':'LATAM','Dutch Caribbean':'LATAM','Saint Pierre and Miquelon':'LATAM','United States Virgin Islands':'LATAM','Sint Maarten':'LATAM','Saint Martin':'LATAM','Turks and Caicos Islands':'LATAM','Cayman Islands':'LATAM','Bermuda':'LATAM','Saint Kitts and Nevis':'LATAM','Antigua and Barbuda':'LATAM','Saint Vincent and the Grenadines':'LATAM','Grenada':'LATAM','Dominica':'LATAM','Guadeloupe':'LATAM','Martinique':'LATAM','Anguilla':'LATAM','Montserrat':'LATAM',
      // EU (Europe)
      'Germany':'EU','UK':'EU','France':'EU','Italy':'EU','Spain':'EU','Netherlands':'EU','Poland':'EU','Belgium':'EU','Sweden':'EU','Switzerland':'EU','Greece':'EU','Portugal':'EU','Czech Republic':'EU','Romania':'EU','Hungary':'EU','Bulgaria':'EU','Croatia':'EU','Serbia':'EU','Slovakia':'EU','Slovenia':'EU','Austria':'EU','Denmark':'EU','Norway':'EU','Finland':'EU','Ireland':'EU','Cyprus':'EU','Albania':'EU','Bosnia':'EU','Macedonia':'EU','Montenegro':'EU','Kosovo':'EU','Iceland':'EU','Luxembourg':'EU','Malta':'EU','Monaco':'EU','Andorra':'EU','Liechtenstein':'EU','San Marino':'EU','Vatican':'EU','Jersey':'EU','Guernsey':'EU','Isle of Man':'EU','Faroe Islands':'EU','Greenland':'EU','Svalbard':'EU','Lithuania':'EU','Latvia':'EU','Estonia':'EU','Moldova':'EU','Belarus':'EU',
      // MENA (Middle East and North Africa)
      'Turkey':'MENA','Iraq':'MENA','Iran':'MENA','Saudi Arabia':'MENA','UAE':'MENA','Israel':'MENA','Jordan':'MENA','Lebanon':'MENA','Kuwait':'MENA','Qatar':'MENA','Oman':'MENA','Bahrain':'MENA','Yemen':'MENA','Syria':'MENA','Palestine':'MENA','Egypt':'MENA','Morocco':'MENA','Algeria':'MENA','Tunisia':'MENA','Libya':'MENA','Sudan':'MENA','Mauritania':'MENA',
      // SEA (Southeast Asia)
      'Indonesia':'SEA','Thailand':'SEA','Vietnam':'SEA','Philippines':'SEA','Malaysia':'SEA','Singapore':'SEA','Myanmar':'SEA','Cambodia':'SEA','Laos':'SEA','Brunei':'SEA','East Timor':'SEA',
      // EA (East Asia)
      'China':'EA','Japan':'EA','Korea':'EA','South Korea':'EA','Taiwan':'EA','Hong Kong':'EA','Macau':'EA','Macao':'EA','Mongolia':'EA','North Korea':'EA',
      // SA (South Asia)
      'India':'SA','Pakistan':'SA','Bangladesh':'SA','Sri Lanka':'SA','Nepal':'SA','Afghanistan':'SA','Bhutan':'SA','Maldives':'SA',
      // CIS (Commonwealth of Independent States)
      'Russia':'CIS','Ukraine':'CIS','Kazakhstan':'CIS','Uzbekistan':'CIS','Kyrgyzstan':'CIS','Tajikistan':'CIS','Turkmenistan':'CIS','Azerbaijan':'CIS','Armenia':'CIS','Georgia':'CIS',
      // AF (Africa - MENA ì œì™¸)
      'South Africa':'AF','Nigeria':'AF','South Sudan':'AF','Ethiopia':'AF','Kenya':'AF','Tanzania':'AF','Uganda':'AF','Ghana':'AF','Ivory Coast':'AF','CÃ´te dIvoire':'AF','Senegal':'AF','Cameroon':'AF','Angola':'AF','Mozambique':'AF','Madagascar':'AF','Zimbabwe':'AF','Zambia':'AF','Malawi':'AF','Rwanda':'AF','Burundi':'AF','Somalia':'AF','Djibouti':'AF','Eritrea':'AF','Mali':'AF','Burkina Faso':'AF','Niger':'AF','Chad':'AF','Central African Republic':'AF','Congo':'AF','DR Congo':'AF','Gabon':'AF','Equatorial Guinea':'AF','Sao Tome':'AF','Sao Tome and Principe':'AF','Guinea':'AF','Sierra Leone':'AF','Liberia':'AF','Togo':'AF','Benin':'AF','Mauritius':'AF','Seychelles':'AF','Comoros':'AF','Cape Verde':'AF','Guinea-Bissau':'AF','Gambia':'AF','Lesotho':'AF','Swaziland':'AF','Botswana':'AF','Namibia':'AF','Reunion':'AF',
      // OCE (Oceania)
      'Australia':'OCE','New Zealand':'OCE','Papua New Guinea':'OCE','Fiji':'OCE','Fiji Islands':'OCE','Solomon Islands':'OCE','Vanuatu':'OCE','Samoa':'OCE','Tonga':'OCE','Palau':'OCE','Micronesia':'OCE','Federated States of Micronesia':'OCE','Marshall Islands':'OCE','Norfolk Island':'OCE','Christmas Island':'OCE','Cocos Islands':'OCE','French Polynesia':'OCE','New Caledonia':'OCE','Cook Islands':'OCE','Guam':'OCE','Northern Mariana Islands':'OCE','Niue':'OCE'
    };

    const getContinent = (c)=> countryToContinent[c] || 'OTHER';

    // ---------- ìƒˆë¡œìš´ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (ë³€í™”ëŸ‰ì— ë”°ë¼ ë³´ê°„) ----------
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }
    
    function rgbToHex(r, g, b) {
      return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }
    
    function interpolateColor(color1, color2, factor) {
      const rgb1 = hexToRgb(color1);
      const rgb2 = hexToRgb(color2);
      if (!rgb1 || !rgb2) return color1;
      
      const r = Math.round(rgb1.r + (rgb2.r - rgb1.r) * factor);
      const g = Math.round(rgb1.g + (rgb2.g - rgb1.g) * factor);
      const b = Math.round(rgb1.b + (rgb2.b - rgb1.b) * factor);
      
      return rgbToHex(r, g, b);
    }
    
    function colorFromChange(change, intensity = 1) {
      // ìƒ‰ìƒ ì •ì˜
      const colors = {
        pos3: '#30cc5a',  // +3%
        pos2: '#2f9e4f',  // +2%
        pos1: '#3e7c55',  // +1%
        zero: '#414554',  // 0%
        neg1: '#8b444e',  // -1%
        neg2: '#bf4045',  // -2%
        neg3: '#f63538'   // -3%
      };
      
      // ë³€í™”ìœ¨ì— ë”°ë¼ ìƒ‰ìƒ ë³´ê°„
      if (change >= 3) {
        return colors.pos3;
      } else if (change >= 2) {
        const factor = (change - 2) / 1; // 2~3 ì‚¬ì´ì˜ ë¹„ìœ¨
        return interpolateColor(colors.pos2, colors.pos3, factor);
      } else if (change >= 1) {
        const factor = (change - 1) / 1; // 1~2 ì‚¬ì´ì˜ ë¹„ìœ¨
        return interpolateColor(colors.pos1, colors.pos2, factor);
      } else if (change > 0) {
        const factor = change / 1; // 0~1 ì‚¬ì´ì˜ ë¹„ìœ¨
        return interpolateColor(colors.zero, colors.pos1, factor);
      } else if (change === 0 || (change > -0.5 && change < 0.5)) {
        return colors.zero;
      } else if (change > -1) {
        const factor = Math.abs(change) / 1; // 0~1 ì‚¬ì´ì˜ ë¹„ìœ¨
        return interpolateColor(colors.zero, colors.neg1, factor);
      } else if (change > -2) {
        const factor = (Math.abs(change) - 1) / 1; // 1~2 ì‚¬ì´ì˜ ë¹„ìœ¨
        return interpolateColor(colors.neg1, colors.neg2, factor);
      } else if (change > -3) {
        const factor = (Math.abs(change) - 2) / 1; // 2~3 ì‚¬ì´ì˜ ë¹„ìœ¨
        return interpolateColor(colors.neg2, colors.neg3, factor);
      } else {
        return colors.neg3;
      }
    }

    // ---------- Sample data ----------
    function generateSampleData(){
      const countries = [];
      const names=['Vatican','Saint Pierre and Miquelon','Montserrat','Falkland Islands','San Marino','Isle of Man','Niue','Cuba','Faroe Islands','Dutch Caribbean','Jersey','Bermuda','Sao Tome and Principe','Gibraltar','Andorra','Liechtenstein','Guinea-Bissau','Turks and Caicos Islands','Saint Martin','Sint Maarten','Anguilla','Central African Republic','Equatorial Guinea','Guernsey','Aruba','Burundi','United States Virgin Islands','Saint Kitts and Nevis','Nauru','Bahamas','Cayman Islands','Lesotho','Northern Mariana Islands','Cape Verde','Guadeloupe','Palau','Antigua and Barbuda','Swaziland','Monaco','Martinique','Iceland','Cook Islands','Reunion','Liberia','New Caledonia','Gambia','Sierra Leone','Guinea','French Guiana','Rwanda','Grenada','Togo','Greenland','Benin','Haiti','Angola','South Sudan','Mozambique','Saint Vincent and the Grenadines','Macao','Malta','Namibia','Burkina Faso','Gabon','Barbados','Guam','Seychelles','Djibouti','Marshall Islands','Mali','Cameroon','Belize','Botswana','Trinidad','Zimbabwe','Niger','Estonia','Malawi','Papua New Guinea','Puerto Rico','Fiji','Zambia','Panama','CÃ´te dIvoire','Senegal','Federated States of Micronesia','Luxembourg','Costa Rica','Slovenia','Ghana','Nicaragua','Bolivia','El Salvador','Paraguay','Uganda','Curacao','Uruguay','Korea','French Polynesia','Japan','Latvia','Honduras','Ireland','Suriname','Tonga','Solomon Islands','Montenegro','Denmark','Portugal','Dominica','Norway','Brunei','Croatia','Cyprus','Tunisia','Slovakia','Lithuania','Guatemala','Jamaica','Macedonia','Laos','New Zealand','Ecuador','Maldives','Venezuela','Peru','Tanzania','Chad','Guyana','Finland','Mauritania','Nigeria','Switzerland','Madagascar','China','Belgium','Bosnia and Herzegovina','Bahrain','Austria','East Timor','Albania','Bhutan','Colombia','Chile','Greece','Hungary','Sweden','Czech Republic','Argentina','Tajikistan','Serbia','Sri Lanka','Spain','Moldova','Kenya','Poland','Ethiopia','Italy','Sudan','Australia','Mauritius','Armenia','South Africa','Kuwait','Oman','Qatar','Cambodia','Bulgaria','Iran','Morocco','Kyrgyzstan','Mongolia','Canada','Romania','Georgia','Belarus','Netherlands','Taiwan','Somalia','Israel','Turkmenistan','Mexico','Singapore','Kazakhstan','Brazil','Syria','United Arab Emirates','Palestine','United Kingdom','Afghanistan','Jordan','Yemen','France','Algeria','Nepal','Lebanon','Bangladesh','Philippines','Azerbaijan','Libya','Hong Kong','Thailand','Malaysia','Myanmar','Ukraine','Vietnam','Germany','United States','Saudi Arabia','Uzbekistan','Indonesia','Egypt','Russia','Pakistan','Iraq','Turkey'];
      let seed=12345; function rnd(){ seed=(seed*9301+49297)%233280; return seed/233280; }
      
      // 7ì¼ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
      const allDates = [];
      const today = new Date();
      for(let d=6; d>=0; d--){
        const date = new Date(today);
        date.setDate(date.getDate() - d);
        allDates.push(`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`);
      }
      
      const trafficByDate = {};
      allDates.forEach(date => { trafficByDate[date] = []; }); // ëª¨ë“  ë‚ ì§œ ì´ˆê¸°í™”
      
      for(let i=0;i<250;i++){
        const name = i<names.length?names[i]:`Country${i+1}`;
        countries.push(name);
        const base=500000*Math.pow(0.92,i);
        const v=base*0.1*(rnd()-0.5);
        let prev=Math.max(1000,Math.round(base+v));
        
        // ê° ë‚ ì§œë³„ íŠ¸ë˜í”½ ìƒì„±
        allDates.forEach((date, idx) => {
          if(idx === 0){
            trafficByDate[date].push(prev);
          } else {
            prev = Math.round(prev*(1+(rnd()*0.1-0.05)));
            trafficByDate[date].push(prev);
          }
        });
      }
      
      const lastDate = allDates[allDates.length - 1];
      return {Country:countries, allDates:allDates, trafficByDate:trafficByDate, lastDate:lastDate};
    }

    const sampleData = generateSampleData();
    let currentData = sampleData;
    let rawCsvRows = null; // ì›ë³¸ CSV ë°ì´í„° ì €ì¥

    // ---------- CSV load ----------
    document.getElementById('btnLoad').addEventListener('click', ()=>{
      const f=document.getElementById('csvFile').files[0];
      if(!f){ alert('Please select a file.'); return; }
      Papa.parse(f,{header:true,skipEmptyLines:true,
        complete:({data})=>{ 
          rawCsvRows = data; // ì›ë³¸ ë°ì´í„° ì €ì¥
          const p=processData(data); 
          if(p){ 
            currentData=p; 
            document.getElementById('status').textContent='CSV Loaded'; 
            createTreemap(currentData); 
          } 
        },
        error:(e)=> alert('Error reading CSV: '+e)
      });
    });
    
    // ë‚ ì§œ ë²”ìœ„ í•„í„° ì ìš©
    document.getElementById('btnApplyDateRange').addEventListener('click', ()=>{
      if(!rawCsvRows || rawCsvRows.length === 0){
        alert('Please load CSV file first.');
        return;
      }
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      if(!startDate || !endDate){
        alert('Please select both start and end dates.');
        return;
      }
      
      const start = new Date(startDate);
      const end = new Date(endDate);
      end.setHours(23, 59, 59, 999); // ì¢…ë£Œì¼ í¬í•¨
      
      if(start > end){
        alert('Start date must be before end date.');
        return;
      }
      
      // ë‚ ì§œ ë²”ìœ„ í•„í„°ë§
      const firstRow = rawCsvRows[0] || {};
      const allKeys = Object.keys(firstRow);
      const findColumn = (keys, possibleNames) => {
        const lowerKeys = keys.map(k => k.toLowerCase());
        for(const name of possibleNames){
          const lowerName = name.toLowerCase();
          const idx = lowerKeys.indexOf(lowerName);
          if(idx !== -1) return keys[idx];
        }
        return null;
      };
      
      const dateCol = findColumn(allKeys, ['Date', 'date', 'ë‚ ì§œ', 'Date']);
      
      if(!dateCol){
        alert('Date column not found. Date range filter only works with Date,Country,Traffic format.');
        return;
      }
      
      // ë‚ ì§œ ì •ê·œí™” í•¨ìˆ˜
      const normalizeDate = (dateStr) => {
        let normalized = dateStr.toString().trim();
        normalized = normalized.replace(/\./g, '-').replace(/\s+/g, '');
        normalized = normalized.replace(/-+/g, '-');
        normalized = normalized.replace(/^-+|-+$/g, '');
        
        const parts = normalized.split('-');
        if(parts.length >= 3){
          const year = parseInt(parts[0]);
          const month = parseInt(parts[1]);
          const day = parseInt(parts[2]);
          if(!isNaN(year) && !isNaN(month) && !isNaN(day)){
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          }
        }
        return normalized;
      };
      
      // ë‚ ì§œ ë²”ìœ„ ë‚´ ë°ì´í„°ë§Œ í•„í„°ë§
      const filteredRows = rawCsvRows.filter(r => {
        if(!r[dateCol]) return false;
        const dateStr = normalizeDate(r[dateCol]);
        const rowDate = new Date(dateStr);
        if(isNaN(rowDate)) return false;
        return rowDate >= start && rowDate <= end;
      });
      
      if(filteredRows.length === 0){
        alert('No data found in the selected date range.');
        return;
      }
      
      const p = processData(filteredRows);
      if(p){
        currentData = p;
        document.getElementById('status').textContent = `CSV Loaded (${filteredRows.length} rows, ${startDate} ~ ${endDate})`;
        createTreemap(currentData);
      }
    });
    
    // ë‚ ì§œ ë²”ìœ„ í•„í„° ì´ˆê¸°í™”
    document.getElementById('btnClearDateRange').addEventListener('click', ()=>{
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      if(rawCsvRows && rawCsvRows.length > 0){
        const p = processData(rawCsvRows);
        if(p){
          currentData = p;
          document.getElementById('status').textContent = 'CSV Loaded';
          createTreemap(currentData);
        }
      }
    });

    function processData(rows){
      try{
        // Date,Country,Traffic (long format) - ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ì°¾ê¸°
        // ë‚ ì§œê°€ ì¤‘êµ¬ë‚œë°©ìœ¼ë¡œ ìˆì–´ë„ ë‚˜ë¼ë³„ë¡œ í”¼ë²—í•˜ì—¬ ì²˜ë¦¬
        const firstRow = rows[0] || {};
        const allKeys = Object.keys(firstRow);
        
        // ì»¬ëŸ¼ëª… ì°¾ê¸° (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
        const findColumn = (keys, possibleNames) => {
          const lowerKeys = keys.map(k => k.toLowerCase());
          for(const name of possibleNames){
            const lowerName = name.toLowerCase();
            const idx = lowerKeys.indexOf(lowerName);
            if(idx !== -1) return keys[idx];
          }
          return null;
        };
        
        const dateCol = findColumn(allKeys, ['Date', 'date', 'ë‚ ì§œ', 'Date']);
        const countryCol = findColumn(allKeys, ['Country', 'country', 'êµ­ê°€', 'Country']);
        const trafficCol = findColumn(allKeys, ['Traffic', 'traffic', 'íŠ¸ë˜í”½', 'DAU', 'dau', 'Traffic']);
        
        if(dateCol && countryCol && trafficCol){
          
          // êµ­ê°€ë³„ë¡œ ë°ì´í„° ê·¸ë£¹í™”
          const countryDataMap = {};
          
          // ë‚ ì§œ ì •ê·œí™” í•¨ìˆ˜
          const normalizeDate = (dateStr) => {
            let normalized = dateStr.toString().trim();
            normalized = normalized.replace(/\./g, '-').replace(/\s+/g, '');
            normalized = normalized.replace(/-+/g, '-');
            normalized = normalized.replace(/^-+|-+$/g, '');
            
            const parts = normalized.split('-');
            if(parts.length >= 3){
              const year = parseInt(parts[0]);
              const month = parseInt(parts[1]);
              const day = parseInt(parts[2]);
              if(!isNaN(year) && !isNaN(month) && !isNaN(day)){
                return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
              }
            }
            return normalized;
          };
          
          rows.forEach(r=>{
            if(r[dateCol] && r[countryCol] && r[trafficCol]){
              const dateStr = normalizeDate(r[dateCol]);
              const country = r[countryCol].toString().trim();
              const traffic = +r[trafficCol];
              
              if(!countryDataMap[country]) countryDataMap[country] = {};
              countryDataMap[country][dateStr] = traffic;
            }
          });
          
          // ê° êµ­ê°€ë³„ë¡œ ë‚ ì§œ ì •ë ¬í•˜ê³  ëª¨ë“  ë‚ ì§œ ë°ì´í„° ì‚¬ìš©
          const countries = Object.keys(countryDataMap);
          const c = [];
          const allDates = new Set(); // ëª¨ë“  ë‚ ì§œ ìˆ˜ì§‘
          
          countries.forEach(country => {
            const dates = Object.keys(countryDataMap[country]).sort((a,b)=>{
              const dateA = new Date(a);
              const dateB = new Date(b);
              if(!isNaN(dateA) && !isNaN(dateB)) return dateA - dateB;
              return a.localeCompare(b);
            });
            
            dates.forEach(d => allDates.add(d));
            
            if(dates.length < 2){
              // ìµœì†Œ 2ì¼ ë°ì´í„° í•„ìš” (DoD ê³„ì‚°ì„ ìœ„í•´)
              return; // ì´ êµ­ê°€ëŠ” ìŠ¤í‚µ
            }
            
            c.push(country);
          });
          
          // ëª¨ë“  ë‚ ì§œ ì •ë ¬
          const sortedDates = Array.from(allDates).sort((a,b)=>{
            const dateA = new Date(a);
            const dateB = new Date(b);
            if(!isNaN(dateA) && !isNaN(dateB)) return dateA - dateB;
            return a.localeCompare(b);
          });
          
          // ë‚ ì§œë³„ íŠ¸ë˜í”½ ë°ì´í„° êµ¬ì„±: trafficByDate[date][countryIndex] = traffic
          const trafficByDate = {};
          sortedDates.forEach(date => {
            trafficByDate[date] = [];
            c.forEach(country => {
              trafficByDate[date].push(countryDataMap[country][date] || 0);
            });
          });
          
          const lastDate = sortedDates.length > 0 ? sortedDates[sortedDates.length - 1] : null;
          
          if(!c.length){ alert('No valid data found. Need at least 2 days of data for each country.'); return null; }
          return {Country:c, allDates:sortedDates, trafficByDate:trafficByDate, lastDate:lastDate};
        }
        
        alert('Unsupported CSV format. Required: Date,Country,Traffic (or ë‚ ì§œ,êµ­ê°€,íŠ¸ë˜í”½)\në‚ ì§œëŠ” ì¤‘êµ¬ë‚œë°©ìœ¼ë¡œ ìˆì–´ë„ ë‚˜ë¼ë³„ë¡œ ìë™ í”¼ë²—í•˜ì—¬ ì²˜ë¦¬ë©ë‹ˆë‹¤.');
        return null;
      }catch(e){ alert('Error processing data: '+e); return null; }
    }

    // ---------- Stats ----------
    function calculateStats(data){
      const avgTraffic=[], change=[], lastDayTraffic=[];
      const {Country, allDates, trafficByDate} = data;
      const comparisonType = document.getElementById('comparisonType').value || 'WoW';
      
      // ë§ˆì§€ë§‰ ë‚ ì§œ ì°¾ê¸°
      const lastDate = allDates.length > 0 ? new Date(allDates[allDates.length - 1]) : null;
      
      for(let i=0;i<Country.length;i++){
        // ë§ˆì§€ë§‰ ë‚  íŠ¸ë˜í”½
        const lastDayValue = (lastDate && trafficByDate[allDates[allDates.length - 1]] && trafficByDate[allDates[allDates.length - 1]][i]) || 0;
        lastDayTraffic.push(lastDayValue);
        
        // ë¹„êµ íƒ€ì…ì— ë”°ë¼ í‘œì‹œí•  íŠ¸ë˜í”½ ê°’ ê³„ì‚°
        let displayTraffic = 0;
        
        if(comparisonType === 'WoW' && lastDate && !isNaN(lastDate)){
          // WoW: í˜„ì¬ ì£¼ì˜ ì›”~í†  í‰ê· 
          const lastDayOfWeek = lastDate.getDay();
          const daysFromMonday = (lastDayOfWeek === 0) ? 6 : lastDayOfWeek - 1;
          const currentWeekMonday = new Date(lastDate);
          currentWeekMonday.setDate(lastDate.getDate() - daysFromMonday);
          currentWeekMonday.setHours(0, 0, 0, 0);
          const currentWeekEnd = new Date(currentWeekMonday);
          currentWeekEnd.setDate(currentWeekMonday.getDate() + 5);
          currentWeekEnd.setHours(23, 59, 59, 999);
          
          const currentWeekDates = allDates.filter(d => {
            const dObj = new Date(d);
            dObj.setHours(0, 0, 0, 0);
            return dObj >= currentWeekMonday && dObj <= currentWeekEnd;
          });
          
          if(currentWeekDates.length > 0){
            let currentWeekSum = 0;
            let currentWeekCount = 0;
            currentWeekDates.forEach(date => {
              if(trafficByDate[date] && trafficByDate[date][i] !== undefined){
                currentWeekSum += trafficByDate[date][i];
                currentWeekCount++;
              }
            });
            displayTraffic = currentWeekCount > 0 ? currentWeekSum / currentWeekCount : lastDayValue;
          } else {
            displayTraffic = lastDayValue;
          }
        } else if(comparisonType === 'DoD'){
          // DoD: ë§ˆì§€ë§‰ ë‚  íŠ¸ë˜í”½
          displayTraffic = lastDayValue;
        } else {
          // MoM, YoY: ì „ì²´ ê¸°ê°„ í‰ê·  (A.DAU)
          let sum = 0;
          let count = 0;
          allDates.forEach(date => {
            if(trafficByDate[date] && trafficByDate[date][i] !== undefined){
              sum += trafficByDate[date][i];
              count++;
            }
          });
          displayTraffic = count > 0 ? sum / count : lastDayValue;
        }
        
        avgTraffic.push(displayTraffic);
        
        // ë¹„êµ ê¸°ì¤€ì¼ ì°¾ê¸°
        let compareDate = null;
        let compareValue = null;
        
        if(lastDate && !isNaN(lastDate)){
          const compareDateObj = new Date(lastDate);
          
          switch(comparisonType){
            case 'DoD':
              // Day over Day: ì „ì¼ ëŒ€ë¹„ (ë§ˆì§€ë§‰ ë‚  vs ë§ˆì§€ë§‰-1ì¼)
              if(allDates.length >= 2){
                const prevDate = allDates[allDates.length - 2];
                if(trafficByDate[prevDate] && trafficByDate[prevDate][i] !== undefined){
                  compareValue = trafficByDate[prevDate][i];
                }
              }
              break;
              
            case 'WoW':
              // Week over Week: ì›”~í†  ê¸°ì¤€ ì§ì „ì£¼ ë¹„êµ
              // ìµœì‹  ë‚ ì§œì˜ ìš”ì¼ í™•ì¸ (0=ì¼, 1=ì›”, ..., 6=í† )
              const lastDayOfWeek = compareDateObj.getDay();
              
              // ìµœì‹  ë‚ ì§œê°€ ì†í•œ ì£¼ì˜ ì›”ìš”ì¼ ì°¾ê¸°
              const daysFromMonday = (lastDayOfWeek === 0) ? 6 : lastDayOfWeek - 1; // ì¼ìš”ì¼ì´ë©´ 6ì¼ ì „ì´ ì›”ìš”ì¼
              const currentWeekMonday = new Date(compareDateObj);
              currentWeekMonday.setDate(compareDateObj.getDate() - daysFromMonday);
              currentWeekMonday.setHours(0, 0, 0, 0);
              
              // ì§ì „ ì£¼ì˜ ì›”ìš”ì¼ ì°¾ê¸° (7ì¼ ì „)
              const prevWeekMonday = new Date(currentWeekMonday);
              prevWeekMonday.setDate(currentWeekMonday.getDate() - 7);
              
              // ì§ì „ ì£¼ì˜ ì›”~í†  ë²”ìœ„ (ì›”ìš”ì¼ë¶€í„° í† ìš”ì¼ê¹Œì§€)
              const prevWeekStart = new Date(prevWeekMonday);
              prevWeekStart.setHours(0, 0, 0, 0);
              const prevWeekEnd = new Date(prevWeekMonday);
              prevWeekEnd.setDate(prevWeekMonday.getDate() + 5); // ì›”~í†  (6ì¼)
              prevWeekEnd.setHours(23, 59, 59, 999);
              
              // ì§ì „ ì£¼ì˜ ì›”~í†  ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  í‰ê·  ê³„ì‚°
              const prevWeekDates = allDates.filter(d => {
                const dObj = new Date(d);
                dObj.setHours(0, 0, 0, 0);
                return dObj >= prevWeekStart && dObj <= prevWeekEnd;
              });
              
              if(prevWeekDates.length > 0){
                // ì§ì „ ì£¼ì˜ í‰ê·  íŠ¸ë˜í”½ ê³„ì‚°
                let prevWeekSum = 0;
                let prevWeekCount = 0;
                prevWeekDates.forEach(date => {
                  if(trafficByDate[date] && trafficByDate[date][i] !== undefined){
                    prevWeekSum += trafficByDate[date][i];
                    prevWeekCount++;
                  }
                });
                
                if(prevWeekCount > 0){
                  compareValue = prevWeekSum / prevWeekCount;
                } else {
                  // í‰ê· ì„ êµ¬í•  ìˆ˜ ì—†ìœ¼ë©´ ë™ì¼í•œ ìš”ì¼ì˜ ê°’ ì‚¬ìš©
                  const prevWeekSameDay = new Date(prevWeekMonday);
                  prevWeekSameDay.setDate(prevWeekMonday.getDate() + daysFromMonday);
                  const prevWeekSameDayStr = `${prevWeekSameDay.getFullYear()}-${String(prevWeekSameDay.getMonth()+1).padStart(2,'0')}-${String(prevWeekSameDay.getDate()).padStart(2,'0')}`;
                  const closestDate = allDates.filter(d => {
                    const dObj = new Date(d);
                    const diff = Math.abs((dObj - prevWeekSameDay) / (1000 * 60 * 60 * 24));
                    return diff <= 1;
                  }).sort((a,b) => {
                    const aDiff = Math.abs((new Date(a) - prevWeekSameDay) / (1000 * 60 * 60 * 24));
                    const bDiff = Math.abs((new Date(b) - prevWeekSameDay) / (1000 * 60 * 60 * 24));
                    return aDiff - bDiff;
                  })[0];
                  
                  if(closestDate && trafficByDate[closestDate] && trafficByDate[closestDate][i] !== undefined){
                    compareValue = trafficByDate[closestDate][i];
                  }
                }
              } else {
                // ì§ì „ ì£¼ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë™ì¼í•œ ìš”ì¼ì˜ ê°’ ì‚¬ìš©
                const prevWeekSameDay = new Date(prevWeekMonday);
                prevWeekSameDay.setDate(prevWeekMonday.getDate() + daysFromMonday);
                const prevWeekSameDayStr = `${prevWeekSameDay.getFullYear()}-${String(prevWeekSameDay.getMonth()+1).padStart(2,'0')}-${String(prevWeekSameDay.getDate()).padStart(2,'0')}`;
                const closestDate = allDates.filter(d => {
                  const dObj = new Date(d);
                  const diff = Math.abs((dObj - prevWeekSameDay) / (1000 * 60 * 60 * 24));
                  return diff <= 1;
                }).sort((a,b) => {
                  const aDiff = Math.abs((new Date(a) - prevWeekSameDay) / (1000 * 60 * 60 * 24));
                  const bDiff = Math.abs((new Date(b) - prevWeekSameDay) / (1000 * 60 * 60 * 24));
                  return aDiff - bDiff;
                })[0];
                
                if(closestDate && trafficByDate[closestDate] && trafficByDate[closestDate][i] !== undefined){
                  compareValue = trafficByDate[closestDate][i];
                }
              }
              break;
              
            case 'MoM':
              // Month over Month: í•œ ë‹¬ ì „
              compareDateObj.setMonth(compareDateObj.getMonth() - 1);
              compareDate = `${compareDateObj.getFullYear()}-${String(compareDateObj.getMonth()+1).padStart(2,'0')}-${String(compareDateObj.getDate()).padStart(2,'0')}`;
              // ê°€ì¥ ê°€ê¹Œìš´ ë‚ ì§œ ì°¾ê¸°
              const momDates = allDates.filter(d => {
                const dObj = new Date(d);
                const diff = Math.abs((dObj - compareDateObj) / (1000 * 60 * 60 * 24));
                return diff <= 3; // 3ì¼ ì´ë‚´ ì°¨ì´
              });
              if(momDates.length > 0){
                const closestDate = momDates.sort((a,b) => {
                  const aDiff = Math.abs((new Date(a) - compareDateObj) / (1000 * 60 * 60 * 24));
                  const bDiff = Math.abs((new Date(b) - compareDateObj) / (1000 * 60 * 60 * 24));
                  return aDiff - bDiff;
                })[0];
                if(trafficByDate[closestDate] && trafficByDate[closestDate][i] !== undefined){
                  compareValue = trafficByDate[closestDate][i];
                }
              }
              break;
              
            case 'YoY':
              // Year over Year: 1ë…„ ì „
              compareDateObj.setFullYear(compareDateObj.getFullYear() - 1);
              compareDate = `${compareDateObj.getFullYear()}-${String(compareDateObj.getMonth()+1).padStart(2,'0')}-${String(compareDateObj.getDate()).padStart(2,'0')}`;
              // ê°€ì¥ ê°€ê¹Œìš´ ë‚ ì§œ ì°¾ê¸°
              const yoyDates = allDates.filter(d => {
                const dObj = new Date(d);
                const diff = Math.abs((dObj - compareDateObj) / (1000 * 60 * 60 * 24));
                return diff <= 7; // 7ì¼ ì´ë‚´ ì°¨ì´
              });
              if(yoyDates.length > 0){
                const closestDate = yoyDates.sort((a,b) => {
                  const aDiff = Math.abs((new Date(a) - compareDateObj) / (1000 * 60 * 60 * 24));
                  const bDiff = Math.abs((new Date(b) - compareDateObj) / (1000 * 60 * 60 * 24));
                  return aDiff - bDiff;
                })[0];
                if(trafficByDate[closestDate] && trafficByDate[closestDate][i] !== undefined){
                  compareValue = trafficByDate[closestDate][i];
                }
              }
              break;
          }
        }
        
        // ë³€í™”ìœ¨ ê³„ì‚°
        // WoWì˜ ê²½ìš°: í˜„ì¬ ì£¼ í‰ê·  vs ì§ì „ ì£¼ í‰ê· 
        // ë‹¤ë¥¸ ê²½ìš°: ë§ˆì§€ë§‰ ë‚  vs ë¹„êµì¼
        let currentValue = lastDayValue;
        if(comparisonType === 'WoW' && lastDate && !isNaN(lastDate)){
          // í˜„ì¬ ì£¼ì˜ ì›”~í†  í‰ê·  ê³„ì‚°
          const lastDayOfWeek = lastDate.getDay();
          const daysFromMonday = (lastDayOfWeek === 0) ? 6 : lastDayOfWeek - 1;
          const currentWeekMonday = new Date(lastDate);
          currentWeekMonday.setDate(lastDate.getDate() - daysFromMonday);
          currentWeekMonday.setHours(0, 0, 0, 0);
          const currentWeekEnd = new Date(currentWeekMonday);
          currentWeekEnd.setDate(currentWeekMonday.getDate() + 5); // ì›”~í† 
          currentWeekEnd.setHours(23, 59, 59, 999);
          
          const currentWeekDates = allDates.filter(d => {
            const dObj = new Date(d);
            dObj.setHours(0, 0, 0, 0);
            return dObj >= currentWeekMonday && dObj <= currentWeekEnd;
          });
          
          if(currentWeekDates.length > 0){
            let currentWeekSum = 0;
            let currentWeekCount = 0;
            currentWeekDates.forEach(date => {
              if(trafficByDate[date] && trafficByDate[date][i] !== undefined){
                currentWeekSum += trafficByDate[date][i];
                currentWeekCount++;
              }
            });
            if(currentWeekCount > 0){
              currentValue = currentWeekSum / currentWeekCount;
            }
          }
        }
        
        if(compareValue !== null && compareValue > 0 && currentValue > 0){
          change.push(((currentValue - compareValue) / compareValue) * 100);
        } else {
          change.push(0);
        }
      }
      const topN = +document.getElementById('topCount').value || 180;
      const sortBy = document.getElementById('sortBy').value || 'revenue';
      let idx;
      if(sortBy==='revenue'){
        // í‰ê·  DAU ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
        idx=Array.from({length:data.Country.length},(_,i)=>i).sort((a,b)=> avgTraffic[b]-avgTraffic[a]).slice(0,topN);
      } else if(sortBy==='change_desc'){
        // + ë³€í™”ëŸ‰ í° ìˆœ (ë³€í™”ëŸ‰ ì ˆëŒ€ê°’ì´ í° ìˆœì„œëŒ€ë¡œ)
        idx=Array.from({length:data.Country.length},(_,i)=>i)
          .sort((a,b)=> Math.abs(change[b])-Math.abs(change[a])) // ì ˆëŒ€ê°’ ê¸°ì¤€ í° ìˆœì„œ
          .slice(0,topN);
      } else if(sortBy==='change_asc'){
        // - ë³€í™”ëŸ‰ í° ìˆœ (í•˜ë½í­ì´ í° ìˆœì„œëŒ€ë¡œ, ìŒìˆ˜ ì¤‘ ì ˆëŒ€ê°’ í° ìˆœ)
        idx=Array.from({length:data.Country.length},(_,i)=>i)
          .filter(i=> change[i] < 0) // ìŒìˆ˜ë§Œ í•„í„°ë§
          .sort((a,b)=> Math.abs(change[a])-Math.abs(change[b])) // ì ˆëŒ€ê°’ ê¸°ì¤€ í° ìˆœì„œ (í•˜ë½í­ í° ìˆœ)
          .slice(0,topN);
      }

      const topCountries=idx.map(i=>data.Country[i]);
      const topRevenue=idx.map(i=>avgTraffic[i]); // í‰ê·  DAU ì‚¬ìš©
      const topChange=idx.map(i=>change[i]);
      const avgDAU=topRevenue.reduce((a,b)=>a+b,0)/topRevenue.length; // í‰ê· ì˜ í‰ê·  (A.DAU)
      const avgChange=topChange.reduce((a,b)=>a+b,0)/topChange.length;
      
      // Max Increase/Decrease êµ­ê°€ ì°¾ê¸°
      const maxChangeIdx = topChange.indexOf(Math.max(...topChange));
      const minChangeIdx = topChange.indexOf(Math.min(...topChange));
      const maxChangeCountry = topCountries[maxChangeIdx] || '';
      const minChangeCountry = topCountries[minChangeIdx] || '';
      
      // Traffic Top 10 (í‰ê·  DAU ê¸°ì¤€)
      const allCountries = data.Country;
      const trafficTop10 = Array.from({length:allCountries.length},(_,i)=>i)
        .sort((a,b)=> avgTraffic[b]-avgTraffic[a])
        .slice(0,10)
        .map(i=>({
          country: allCountries[i],
          traffic: avgTraffic[i], // í‰ê·  DAU ì‚¬ìš©
          change: change[i]
        }));
      
      // ê¶Œì—­ë³„ íŠ¸ë˜í”½ ì§‘ê³„ (í˜„ì¬ ê¸°ê°„ê³¼ ë¹„êµ ê¸°ê°„ ëª¨ë‘ ê³„ì‚°)
      const regionStats = {};
      const regionCompareStats = {};
      let totalTraffic = 0;
      
      allCountries.forEach((country, i) => {
        const continent = getContinent(country);
        if(!regionStats[continent]){
          regionStats[continent] = {
            traffic: 0,
            compareTraffic: 0
          };
          regionCompareStats[continent] = {
            traffic: 0,
            compareTraffic: 0
          };
        }
        
        // í˜„ì¬ ê¸°ê°„ íŠ¸ë˜í”½ (avgTraffic ì‚¬ìš© - ë¹„êµ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¦„)
        regionStats[continent].traffic += avgTraffic[i];
        totalTraffic += avgTraffic[i];
        
        // ë¹„êµ ê¸°ê°„ íŠ¸ë˜í”½ ê³„ì‚°
        let compareTrafficValue = 0;
        if(comparisonType === 'WoW' && lastDate && !isNaN(lastDate)){
          // WoW: ì§ì „ ì£¼ í‰ê· 
          const lastDayOfWeek = lastDate.getDay();
          const daysFromMonday = (lastDayOfWeek === 0) ? 6 : lastDayOfWeek - 1;
          const currentWeekMonday = new Date(lastDate);
          currentWeekMonday.setDate(lastDate.getDate() - daysFromMonday);
          currentWeekMonday.setHours(0, 0, 0, 0);
          const prevWeekMonday = new Date(currentWeekMonday);
          prevWeekMonday.setDate(currentWeekMonday.getDate() - 7);
          const prevWeekEnd = new Date(prevWeekMonday);
          prevWeekEnd.setDate(prevWeekMonday.getDate() + 5);
          prevWeekEnd.setHours(23, 59, 59, 999);
          
          const prevWeekDates = allDates.filter(d => {
            const dObj = new Date(d);
            dObj.setHours(0, 0, 0, 0);
            return dObj >= prevWeekMonday && dObj <= prevWeekEnd;
          });
          
          if(prevWeekDates.length > 0){
            let prevWeekSum = 0;
            let prevWeekCount = 0;
            prevWeekDates.forEach(date => {
              if(trafficByDate[date] && trafficByDate[date][i] !== undefined){
                prevWeekSum += trafficByDate[date][i];
                prevWeekCount++;
              }
            });
            compareTrafficValue = prevWeekCount > 0 ? prevWeekSum / prevWeekCount : 0;
          }
        } else if(comparisonType === 'DoD'){
          // DoD: ë§ˆì§€ë§‰-1ì¼
          if(allDates.length >= 2){
            const prevDate = allDates[allDates.length - 2];
            compareTrafficValue = (trafficByDate[prevDate] && trafficByDate[prevDate][i] !== undefined) ? trafficByDate[prevDate][i] : 0;
          }
        } else {
          // MoM, YoY: ë¹„êµì¼ íŠ¸ë˜í”½ (ê°œë³„ êµ­ê°€ change ê³„ì‚° ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ)
          if(lastDate && !isNaN(lastDate)){
            const compareDateObj = new Date(lastDate);
            let compareValue = null;
            
            if(comparisonType === 'MoM'){
              compareDateObj.setMonth(compareDateObj.getMonth() - 1);
              const momDates = allDates.filter(d => {
                const dObj = new Date(d);
                const diff = Math.abs((dObj - compareDateObj) / (1000 * 60 * 60 * 24));
                return diff <= 3;
              });
              if(momDates.length > 0){
                const closestDate = momDates.sort((a,b) => {
                  const aDiff = Math.abs((new Date(a) - compareDateObj) / (1000 * 60 * 60 * 24));
                  const bDiff = Math.abs((new Date(b) - compareDateObj) / (1000 * 60 * 60 * 24));
                  return aDiff - bDiff;
                })[0];
                if(trafficByDate[closestDate] && trafficByDate[closestDate][i] !== undefined){
                  compareValue = trafficByDate[closestDate][i];
                }
              }
            } else if(comparisonType === 'YoY'){
              compareDateObj.setFullYear(compareDateObj.getFullYear() - 1);
              const yoyDates = allDates.filter(d => {
                const dObj = new Date(d);
                const diff = Math.abs((dObj - compareDateObj) / (1000 * 60 * 60 * 24));
                return diff <= 7;
              });
              if(yoyDates.length > 0){
                const closestDate = yoyDates.sort((a,b) => {
                  const aDiff = Math.abs((new Date(a) - compareDateObj) / (1000 * 60 * 60 * 24));
                  const bDiff = Math.abs((new Date(b) - compareDateObj) / (1000 * 60 * 60 * 24));
                  return aDiff - bDiff;
                })[0];
                if(trafficByDate[closestDate] && trafficByDate[closestDate][i] !== undefined){
                  compareValue = trafficByDate[closestDate][i];
                }
              }
            }
            compareTrafficValue = compareValue !== null ? compareValue : 0;
          }
        }
        
        regionStats[continent].compareTraffic += compareTrafficValue;
      });
      
      // ê¶Œì—­ë³„ ë°ì´í„° ì •ë¦¬ (íŠ¸ë˜í”½ í° ìˆœì„œëŒ€ë¡œ)
      const regionTrafficList = Object.keys(regionStats).map(region => {
        const currentTraffic = regionStats[region].traffic;
        const compareTraffic = regionStats[region].compareTraffic;
        const regionChange = (compareTraffic > 0 && currentTraffic > 0) 
          ? ((currentTraffic - compareTraffic) / compareTraffic) * 100 
          : 0;
        
        return {
          region: region,
          traffic: currentTraffic,
          share: totalTraffic > 0 ? (currentTraffic / totalTraffic) * 100 : 0,
          avgChange: regionChange
        };
      }).sort((a,b) => b.traffic - a.traffic);
      
      // ë¹„êµ êµ¬ê°„ ì •ë³´ ê³„ì‚°
      let comparisonRangeText = '';
      if(allDates.length > 0){
        const lastDate = new Date(allDates[allDates.length - 1]);
        const comparisonType = document.getElementById('comparisonType').value || 'WoW';
        
        if(comparisonType === 'DoD'){
          if(allDates.length >= 2){
            const prevDate = new Date(allDates[allDates.length - 2]);
            const formatDate = (d) => `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
            comparisonRangeText = `ë¹„êµ êµ¬ê°„: ${formatDate(prevDate)} vs ${formatDate(lastDate)}`;
          }
        } else if(comparisonType === 'WoW'){
          const lastDayOfWeek = lastDate.getDay();
          const daysFromMonday = (lastDayOfWeek === 0) ? 6 : lastDayOfWeek - 1;
          const currentWeekMonday = new Date(lastDate);
          currentWeekMonday.setDate(lastDate.getDate() - daysFromMonday);
          const currentWeekEnd = new Date(currentWeekMonday);
          currentWeekEnd.setDate(currentWeekMonday.getDate() + 5);
          
          const prevWeekMonday = new Date(currentWeekMonday);
          prevWeekMonday.setDate(currentWeekMonday.getDate() - 7);
          const prevWeekEnd = new Date(prevWeekMonday);
          prevWeekEnd.setDate(prevWeekMonday.getDate() + 5);
          
          const formatDate = (d) => `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
          comparisonRangeText = `ë¹„êµ êµ¬ê°„: ${formatDate(prevWeekMonday)}~${formatDate(prevWeekEnd)} vs ${formatDate(currentWeekMonday)}~${formatDate(currentWeekEnd)} (WoW)`;
        } else if(comparisonType === 'MoM'){
          const prevMonth = new Date(lastDate);
          prevMonth.setMonth(lastDate.getMonth() - 1);
          const formatDate = (d) => `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
          comparisonRangeText = `ë¹„êµ êµ¬ê°„: ${formatDate(prevMonth)} vs ${formatDate(lastDate)} (MoM)`;
        } else if(comparisonType === 'YoY'){
          const prevYear = new Date(lastDate);
          prevYear.setFullYear(lastDate.getFullYear() - 1);
          const formatDate = (d) => `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
          comparisonRangeText = `ë¹„êµ êµ¬ê°„: ${formatDate(prevYear)} vs ${formatDate(lastDate)} (YoY)`;
        }
      }
      
      return {topCountries, topRevenue, topChange, avgDAU, avgChange,
              maxChange:Math.max(...topChange), minChange:Math.min(...topChange),
              maxChangeCountry, minChangeCountry, trafficTop10, comparisonRangeText, regionTrafficList};
    }

    // ---------- Render ----------
    const overlay=document.getElementById('loadingOverlay');
    ['topCount','sortBy','groupByContinent','comparisonType'].forEach(id=>{
      document.getElementById(id).addEventListener('change', ()=> createTreemap(currentData));
    });

    function createTreemap(data){
      if(overlay) overlay.style.display='flex';
      setTimeout(()=>{
        const stats=calculateStats(data);
        const topN=+document.getElementById('topCount').value || 180;
        const groupBy=document.getElementById('groupByContinent').checked;

        // KPIs
        const comparisonType = document.getElementById('comparisonType').value || 'WoW';
        const comparisonLabel = {
          'DoD': 'ì „ì¼ ëŒ€ë¹„',
          'WoW': 'ì£¼ê°„ ëŒ€ë¹„ (ì›”~í†  ê¸°ì¤€)',
          'MoM': 'ì›”ê°„ ëŒ€ë¹„',
          'YoY': 'ì—°ê°„ ëŒ€ë¹„'
        }[comparisonType] || 'ì£¼ê°„ ëŒ€ë¹„ (ì›”~í†  ê¸°ì¤€)';
        
            document.getElementById('stats').innerHTML = `
          <div class="stat-item"><div class="stat-label">A.DAU (Average DAU)</div><div class="stat-value">${(stats.avgDAU/1e6).toFixed(2)}M</div></div>
          <div class="stat-item"><div class="stat-label">Avg Change (${comparisonLabel})</div><div class="stat-value ${stats.avgChange>=0?'positive':'negative'}">${stats.avgChange>=0?'+':''}${stats.avgChange.toFixed(2)}%</div></div>
          <div class="stat-item"><div class="stat-label">Max Increase (${comparisonLabel})</div><div class="stat-value positive">+${stats.maxChange.toFixed(2)}% <span style="font-size:14px;opacity:0.8">(${stats.maxChangeCountry})</span></div></div>
          <div class="stat-item"><div class="stat-label">Max Decrease (${comparisonLabel})</div><div class="stat-value negative">${stats.minChange.toFixed(2)}% <span style="font-size:14px;opacity:0.8">(${stats.minChangeCountry})</span></div></div>`;
        
        // Traffic Top 10 í‘œ ì œëª© ì—…ë°ì´íŠ¸ (í‰ê·  DAU ê¸°ì¤€)
        const top10Title = document.getElementById('trafficTop10Title');
        if(top10Title){
          const comparisonType = document.getElementById('comparisonType').value || 'WoW';
          const comparisonLabel = {
            'DoD': 'ì „ì¼ ëŒ€ë¹„',
            'WoW': 'ì£¼ê°„ ëŒ€ë¹„ (ì›”~í†  ê¸°ì¤€)',
            'MoM': 'ì›”ê°„ ëŒ€ë¹„',
            'YoY': 'ì—°ê°„ ëŒ€ë¹„'
          }[comparisonType] || 'ì£¼ê°„ ëŒ€ë¹„ (ì›”~í†  ê¸°ì¤€)';
          top10Title.textContent = `Traffic Top 10 (A.DAU ê¸°ì¤€, ${comparisonLabel})`;
        }
        
        // ë¹„êµ êµ¬ê°„ ì •ë³´ í‘œì‹œ
        const comparisonRange = document.getElementById('comparisonRange');
        if(comparisonRange && stats.comparisonRangeText){
          comparisonRange.textContent = stats.comparisonRangeText;
        } else if(comparisonRange){
          comparisonRange.textContent = '';
        }
        
        // ê¶Œì—­ë³„ íŠ¸ë˜í”½ í‘œ ì œëª© ì—…ë°ì´íŠ¸
        const regionTrafficTitle = document.getElementById('regionTrafficTitle');
        if(regionTrafficTitle){
          const comparisonType = document.getElementById('comparisonType').value || 'WoW';
          let titleSuffix = '';
          if(comparisonType === 'WoW'){
            titleSuffix = ' (í˜„ì¬ ì£¼ ì›”~í†  í‰ê·  ê¸°ì¤€)';
          } else if(comparisonType === 'DoD'){
            titleSuffix = ' (ë§ˆì§€ë§‰ ë‚  ê¸°ì¤€)';
          } else {
            titleSuffix = ' (ì „ì²´ ê¸°ê°„ í‰ê·  ê¸°ì¤€)';
          }
          regionTrafficTitle.textContent = `ê¶Œì—­ë³„ íŠ¸ë˜í”½ ë¹„ì¤‘${titleSuffix}`;
        }
        
        // ê¶Œì—­ë³„ íŠ¸ë˜í”½ í‘œ ì—…ë°ì´íŠ¸
        const regionTrafficBody = document.getElementById('regionTrafficBody');
        if(regionTrafficBody && stats.regionTrafficList){
          // GL ì´í•© ê³„ì‚°
          const glTotal = stats.regionTrafficList.reduce((sum, item) => sum + item.traffic, 0);
          const glAvgChange = stats.regionTrafficList.length > 0 
            ? stats.regionTrafficList.reduce((sum, item) => sum + (item.avgChange * item.traffic), 0) / glTotal
            : 0;
          
          const glChangeColor = glAvgChange >= 0 ? '#00ff00' : '#ff4d4d';
          const glChangeSign = glAvgChange >= 0 ? '+' : '';
          
          regionTrafficBody.innerHTML = stats.regionTrafficList.map((item, idx) => {
            const changeColor = item.avgChange >= 0 ? '#00ff00' : '#ff4d4d';
            const changeSign = item.avgChange >= 0 ? '+' : '';
            return `
              <tr style="border-bottom:1px solid var(--border);${idx % 2 === 0 ? 'background:rgba(255,255,255,0.02)' : ''}">
                <td style="padding:14px;font-size:16px;color:#fff;font-weight:600">${item.region}</td>
                <td style="padding:14px;text-align:right;font-size:16px;color:#fff">${Math.round(item.traffic).toLocaleString()}</td>
                <td style="padding:14px;text-align:right;font-size:16px;color:#fff;font-weight:600">${item.share.toFixed(2)}%</td>
                <td style="padding:14px;text-align:right;font-size:16px;color:${changeColor};font-weight:600">${changeSign}${item.avgChange.toFixed(2)}%</td>
              </tr>
            `;
          }).join('') + `
              <tr style="border-top:2px solid var(--border);background:rgba(46,160,67,0.1);">
                <td style="padding:14px;font-size:16px;color:#fff;font-weight:700">GL (Global)</td>
                <td style="padding:14px;text-align:right;font-size:16px;color:#fff;font-weight:700">${Math.round(glTotal).toLocaleString()}</td>
                <td style="padding:14px;text-align:right;font-size:16px;color:#fff;font-weight:700">100.00%</td>
                <td style="padding:14px;text-align:right;font-size:16px;color:${glChangeColor};font-weight:700">${glChangeSign}${glAvgChange.toFixed(2)}%</td>
              </tr>
            `;
        }
        
        // Traffic Top 10 í‘œ ì—…ë°ì´íŠ¸
        const top10Body = document.getElementById('trafficTop10Body');
        if(top10Body && stats.trafficTop10){
          top10Body.innerHTML = stats.trafficTop10.map((item, idx) => {
            const changeColor = item.change >= 0 ? '#00ff00' : '#ff4d4d';
            const changeSign = item.change >= 0 ? '+' : '';
            return `
              <tr style="border-bottom:1px solid var(--border);${idx % 2 === 0 ? 'background:rgba(255,255,255,0.02)' : ''}">
                <td style="padding:14px;font-size:16px;color:#fff;font-weight:600">${idx + 1}</td>
                <td style="padding:14px;font-size:16px;color:#fff;font-weight:600">${item.country}</td>
                <td style="padding:14px;text-align:right;font-size:16px;color:#fff">${(item.traffic/1e6).toFixed(2)}M</td>
                <td style="padding:14px;text-align:right;font-size:16px;color:${changeColor};font-weight:600">${changeSign}${item.change.toFixed(2)}%</td>
              </tr>
            `;
          }).join('');
        }

        // Build treemap arrays
        let ids=[], labels=[], parents=[], values=[], colors=[], text=[], custom=[];

        if(groupBy){
          const groups={};
          stats.topCountries.forEach((c,i)=>{ const G=getContinent(c); (groups[G]||(groups[G]={c:[],v:[],chg:[]})).c.push(c); groups[G].v.push(stats.topRevenue[i]); groups[G].chg.push(stats.topChange[i]); });
          const continents=Object.keys(groups).sort((a,b)=> groups[b].v.reduce((x,y)=>x+y,0)-groups[a].v.reduce((x,y)=>x+y,0));

          continents.forEach(cont=>{
            const g=groups[cont];
            const total=g.v.reduce((a,b)=>a+b,0);
            const contId=`continent:${cont}`;
            // ëŒ€ë¥™ í…ìŠ¤íŠ¸ í¬ê²Œ (ë³¼ë“œì²´) - Finviz ìŠ¤íƒ€ì¼
            const continentTextShadow = 'text-shadow: 2px 2px 4px rgba(0,0,0,0.7), 0 0 6px rgba(0,0,0,0.6);';
            ids.push(contId); labels.push(cont); parents.push(''); values.push(total); colors.push('#262931'); text.push(`<b style="font-size:86.4px;font-weight:900;letter-spacing:2px;color:#FFFFFF;${continentTextShadow}">${cont}</b>`); custom.push([null,null,cont]);

            // thresholds for label density by share
            const small=0.010, medium=0.025;
            const maxAbsChange = g.chg.length > 0 ? Math.max(...g.chg.map(c => Math.abs(c))) : 1;
            // êµ­ê°€ë³„ ê¸€ì”¨ í¬ê¸° ê³ ì • (ëª¨ë“  êµ­ê°€ ë™ì¼)
            const countryFontSize = 20; // India í¬ê¸°ë¡œ ê³ ì •
            g.c.forEach((country,i)=>{
              const revenue=g.v[i];
              const change=g.chg[i];
              const share=revenue/total; // area fraction approx
              // ë³€í™”ëŸ‰ì— ë”°ë¥¸ ê°•ë„ ê³„ì‚°
              const changeIntensity = maxAbsChange > 0 ? Math.abs(change) / maxAbsChange : 0;
              // ë³€í™”ê°€ í´ìˆ˜ë¡ ë” ì§„í•œ ìƒ‰ìƒ
              const col=colorFromChange(change, changeIntensity);
              ids.push(`country:${cont}:${country}`);
              labels.push(country);
              parents.push(contId);
              values.push(revenue);
              colors.push(col);
              let t='';
              // ë³€í™”ëŸ‰ë§Œ í‘œì‹œ, ë³¼ë“œì²´, ëª…ì•” ì¶”ê°€
              const textShadow = 'text-shadow: 1px 1px 3px rgba(0,0,0,0.7), 0 0 4px rgba(0,0,0,0.5);';
              if(share>=small){
                t = `<b style="font-size:${countryFontSize}px;font-weight:bold;color:#FFFFFF;${textShadow}">${country}</b><br><b style="font-size:${Math.max(12,countryFontSize*0.75)}px;font-weight:bold;color:#FFFFFF;${textShadow}">${change>=0?'+':''}${change.toFixed(1)}%</b>`;
              }else{
                t = `<b style="font-size:${countryFontSize}px;font-weight:bold;color:#FFFFFF;${textShadow}">${country}</b>`;
              }
              text.push(t);
              custom.push([change, revenue, cont]);
            });
          });
                } else {
          const total = stats.topRevenue.reduce((a,b)=>a+b,0);
          const small=0.006;
          const maxAbsChange = stats.topChange.length > 0 ? Math.max(...stats.topChange.map(c => Math.abs(c))) : 1;
          // êµ­ê°€ë³„ ê¸€ì”¨ í¬ê¸° ê³ ì • (ëª¨ë“  êµ­ê°€ ë™ì¼)
          const countryFontSize = 20; // India í¬ê¸°ë¡œ ê³ ì •
          stats.topCountries.forEach((country,i)=>{
            const rev=stats.topRevenue[i]; const ch=stats.topChange[i]; const share=rev/total; const cont=getContinent(country);
            // ë³€í™”ëŸ‰ì— ë”°ë¥¸ ê°•ë„ ê³„ì‚°
            const changeIntensity = maxAbsChange > 0 ? Math.abs(ch) / maxAbsChange : 0;
            // ë³€í™”ê°€ í´ìˆ˜ë¡ ë” ì§„í•œ ìƒ‰ìƒ
            const col = colorFromChange(ch, changeIntensity);
            ids.push(`country::${country}`); labels.push(country); parents.push(''); values.push(rev); colors.push(col);
            let t='';
            // ë³€í™”ëŸ‰ë§Œ í‘œì‹œ, ë³¼ë“œì²´, ëª…ì•” ì¶”ê°€
            const textShadow = 'text-shadow: 1px 1px 3px rgba(0,0,0,0.9), 0 0 5px rgba(0,0,0,0.7);';
            if(share>=small) t = `<b style="font-size:${countryFontSize}px;font-weight:bold;color:#FFFFFF;${textShadow}">${country}</b><br><b style="font-size:${Math.max(12,countryFontSize*0.75)}px;font-weight:bold;color:#FFFFFF;${textShadow}">${ch>=0?'+':''}${ch.toFixed(1)}%</b>`;
            else t = `<b style="font-size:${countryFontSize}px;font-weight:bold;color:#FFFFFF;${textShadow}">${country}</b>`;
            text.push(t);
            custom.push([ch, rev, cont]);
          });
        }

        const height = 900; // fixed height for visual stability

        const trace={
          type:'treemap',
          ids, labels, parents, values,
          text, textinfo:'text', textposition:'middle center',
          marker:{ colors, line:{width:1, color:'#000000'}, depthfade:false },
          tiling:{ pad: 1 },
          branchvalues:'total', maxdepth: groupBy ? 2 : 1,
          hovertemplate:'<b>%{label}</b><br>Traffic: %{value:,.0f}<br>'+
                        'Change: %{customdata[0]:.2f}%<br>Sector: %{customdata[2]}<extra></extra>',
          customdata: custom,
          pathbar:{visible:false}
        };

        const layout={
          paper_bgcolor: '#262931',
          plot_bgcolor: '#262931',
          margin:{l:0,r:0,t:0,b:0}, height,
          font:{family:'Arial, Helvetica, sans-serif',size:11,color:'#FFFFFF'},
          hoverlabel:{bgcolor:'#161b22',bordercolor:'#30363d',font:{color:'#fff'}}
        };

        Plotly.newPlot('treemap',[trace],layout,{responsive:true}).then(()=>{ if(overlay) overlay.style.display='none'; });
      }, 40);
    }

    // initial draw
    window.addEventListener('load',()=>{
      const t=overlay?.querySelector('.loading-text'); if(t) t.textContent='ìƒ˜í”Œ ë°ì´í„°ë¡œ ì´ˆê¸°í™” ì¤‘...';
      setTimeout(()=> createTreemap(currentData), 120);
    });
    </script>
</body>
</html>